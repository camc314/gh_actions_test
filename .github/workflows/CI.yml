name: Test Workflow

on:
  pull_request:
    branches:
      - main

jobs:
  comment:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Test
        run: |
          curl -L \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/camc314/gh_actions_test/commits/${{ github.sha }} > commit.json

          commit_message=$(cat commit.json | jq -r '.commit.message')
          # Basic Comment
          echo "Commit message: $commit_message"

          current_sha=$(echo $commit_message | sed 's/.*Merge \([^ ]*\) into \([^ ]*\).*/\1/')
          target_sha=$(echo $commit_message | sed 's/.*Merge \([^ ]*\) into \([^ ]*\).*/\2/')
          echo "Current SHA: $current_sha"
          echo "Target SHA: $target_sha"

          curl -L \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/camc314/gh_actions_test/commits/$target_sha > target_sha_commit.json

          curl -L \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/camc314/gh_actions_test/commits/$current_sha > current_sha_commit.json

          echo $( cat current_sha_commit.json | jq -r '.commit.message' )
          echo $( cat target_sha_commit.json | jq -r '.commit.message' )

          # Format to String
          # Build updated at <CURRENT_DATE_TIME>
          # Produced from merging <CURRENT_SHA> (target branch) into <TARGET_SHA> (current branch)
          # Build is available at <BUILD_URL>

          # https://www.github.com/<OWNER>/<REPO>/commit/<SHA>
          current_sha_url="https://www.github.com/camc314/gh_actions_test/commit/$current_sha"
          target_sha_url="https://www.github.com/camc314/gh_actions_test/commit/$target_sha"

          current_sha_msg=$( cat current_sha_commit.json | jq -r '.commit.message' )
          target_sha_msg=$( cat target_sha_commit.json | jq -r '.commit.message' )

          # write Below to `comment.md`
          # "<!-- CI Comment --> \nBuild updated at $(date) \nProduced from merging [$current_sha_msg]($current_sha_url) into [$target_sha_msg]($target_sha_url) \nBuild is available at <BUILD_URL>"
          str="<!-- CI Comment --> \nBuild updated at $(date) \nProduced from merging [$current_sha_msg]($current_sha_url) into [$target_sha_msg]($target_sha_url) \nBuild is available at <BUILD_URL>"
          echo $str > comment.md

          cat comment.md

      - name: Find Comment
        uses: peter-evans/find-comment@v2
        id: fc
        continue-on-error: true
        with:
          issue-number: github.event.number
          comment-author: "github-actions[bot]"
          body-includes: <!-- CI Comment -->

      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@v2
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ github.event.number }}
          body-file: comment.md
          edit-mode: replace